# Changes to camdkit
## (in reverse chronological order of release)

## Changes after 0.9.2 and before 1.0.0

### PTP code cleanup and fleshing out of PTP examples and unit tests

The PTP code was extensively cleaned up as was the related portions of the sample code and unit tests.

### cbor2 added as requirement

The Pipfile was updated to reflect `cbor2` now being a required package.

### Python parser code updated

The Python parser error handling was improved and errors in the JSON traversal were corrected.

### PTP priority range clarified

The PTP priority range was established as being that of an 8-bit unsigned integer (_i.e._ 0 <= x < 256).

### PTP profiles captures as JSON enumerated array

The set of PTP profiles was establised as SMPTE 2059-2 and IEEE 1588 default.

### Pydantic used to re-implement`camdkit` 

`camdkit` was completely re-implemented on top of Pydantic (49 files changed, 2,953 lines deleted, 7,461 lines added) with the following consequences:

- Two schemas, not one

  - Serialization schema

    This is what most of you think of as our schema: something that expresses the set of valid metadata that can be passed "
through the wire".

  - Validation schema

    One thing not expressed in the hand-generated JSON schema in classic `camdkit` is the way in which `None` can be a valid  value of a `Parameter`, and the many places where that value of `None` is the default. One might create a `Clip`, and  find that the initial value of (say) `lens_serial_number` is `None`, then set the value of `lens_serial_number` to `"foo"`, read it back to verify that the value is indeed now `"foo"`, then decide to clear it so one explicitly assigns  a value of `None` to the parameter, and one can then read it back to be sure that it is in fact `None` once more.

    None of this would be evident from looking at the published schema generated by classic `camdkit`, because what we publish is a _serialization schema_.

    The Pydantic re-hosting of `camdkit` produces a serialization schema when `Clip.make_json_schema()` is called, but could easily produce a validation schema if that were desirable.

*The temporary construction of invalid objects is no longer possible*

Pydantic validates all the supplied and defaulted fields of objects when they are created, not just later when their `validate()` method is called.

Code such as

```python

import unittest

from camdkit.framework import Timestamp
from camdkit.model import TimingTimestamp

class TempConstructionCases(unittest.TestCase):
  def test_timestamp_is_invalid(self):
    self.assertFalse(TimingTimestamp.validate(Timestamp(-1, 2)))
```

will fail, because in order to run `validate()` against something, that something needs to first be constructed, and
Pydantic won't let you get even that far -- it will raise a `ValidationError` when the attempt to construct a temporary
object `Timestamp(-1, 2)` fails.

*Default values are not serialized.*

Examples:

- TimecodeFormat objects contain a frame rate as well as the usual HH:MM:SS:FF, and this frame rate includes a sub_frame
  component, an integer representing a 0-based index into component pieces of the frame. Metadata parameters associated
  with the first field of an interlaced frame would have a sub_frame component of 0; the second field, 1. (n.b. the
  serialized canonical form of `sub_frame` is `sub_frame`).
  - In classic `camdkit`, the `__init__()` method of `TimecodeFormat` defined in `model.py` defaulted `sub_frame` to 0,
    and the `to_json()` method of `TimingTimecode` in `model.py` always wrote it out.
  - In modified classic `camdkit`, if it turns out the value of `sub_frame` is the default, it is not serialized; it is
    assumed that the deserialization at the other end will reconstitute it from the default.
  - in Pydantic `camdkit` it is not serialized (because all serialization takes place in
    `CompatibleBaseModel.to_json()`, and that method invokes Pydantic's `model_dump` with `exclude_defaults=True`).

*Various deviations from the JSON schema specification are corrected*

Examples:

- The 0-9 range of protocol version number components is now indicated with `minimum` and `maximum` as the prior
  `minValue` and `maxValue` were not valid for integers.

*New range-restricted real-number parameter type*

- `StrictlyPositiveRealParameter` was added to support nominal focal length and focus distance, two parameters where
  beyond negative values being disallowed, zero values are disallowed as well.

*Nominal Focal Length and FocusDistance can no longer be zero*

These two parameters are now based on `StrictlyPositiveRealParameter`

*`RealParameter` and derivative parameters serialize as floats*

In classic `camdkit` a nominal focal length of 13 mm would be serialized as `13`. In Pydantic, the model field for a
nominal focal length serializes as `13.0`. In modified classic `camdkit` the value is cast to a float before being
serialized, thus producing a Pydantic-compatible `13.0`.

*Distortion model name length must be non-blank and < 1024 characters long*

This conforms to what is required of other string parameters.

*PTP leader regex allows lower and upper case hex, and '-' separators*

The regular expression for PTP leaders was changed to support seen-in-the-wild use of both upper-case and lower-case
hex letters (_i.e._ both A-F and a-f) and both colon and hyphen separators.

*Both upper and lower bounds of integer ranges are given*

Example: lens raw encoder values previously specified a minimum of 0 and no maximum; now they specify a minimum of 0 and
a maximum of UINT_MAX (i.e. the
largest unsigned 32-bit integer).

*Many docstrings fit on one line*

PEP 257 (referenced by the all-powerful [PEP 8](https://peps.python.org/pep-0008/)) allows for single-line docstrings;
and PEP 8 says that lines can be up to 79 characters. This increases the readability of the code.

### PTP profile list further clarified

The set of PTP profiles was changed to clarify that there are two IEEE profiles, distinguishable by year, and one SMPTE profile, also denoted with a year.

### `focal_length` parameter renamed to `pinhole_focal_length`

This brings `camdkit` into line with OpenEXR, and the VES efforts (supported strongly by Cooke Optics, an RIS member) to standardize camera and lens metadata semantics.

### Vendor metadata readers updated to set `nominal_focal_length` when appropriate

With the removal of `focal_length` in favor of `pinhole_focal_length`, the code to map camera vendor metadata to canonical camdkit metadata needed to be changed. Save for the Mo-Sys F4 reader, this meant having the readers set `nominal_focal_length`. Note that `nominal_focal_length` is currently a static parameter and this conflicts with the OpenEXR and VES metadata definition where the nominal focal length of a zoom lens can change. It is anticipated that for the 1.0.0 release of `camdkit`, the nominal focal length of a zoom lens will be undefined.

### `pinhole_focal_length`, `f_number` and `t_number` lower bound changed

The semantics of these three metadata were changed to exclude focal lengths and apertures of zero.

### `lens_distortion_is_projection` static parameter removed

The `lens_distortion_is_projection` static parameter was removed.

### `time_source` field of SynchronizationSourcePTP renamed to `leader_time_source`

The renaming brings the leader time source field into line with the other leader-specific fields of the `SynchronizationSourcePTP` object.

### `lens_calibration_history` static parameter added

The `lens_calibration_history` is a sequence of strings documenting when a lens was calibrated.

### Reference code added for Fletcher-16 algorithm to documentation

A short (11-line) implementation is provided.

## Changes after 0.9.1 and before 0.9.2

### Type of `lens_distortion_is_projection` changed

An inadvertent classification of `lens_distortion_is_projection` as a regular parameter was corrected to be static.

### Sub-frame serialization error corrected

The snake-case `sub_frame` was appearing in JSON, where it should have been the camel-case `subFrame`.

### distortion-is-projection serialization error rectified

The serialized form was corrected from `distortionProjection` to `distortionIsProjection`.

### "Complete dynamic example" `frequency` added

The `Synchronization` object of the complete dynamic example now has a specified `frequency` parameter.

### The C++ parser was updated to use a package from Conan

The C++ parser now uses the open-source `opentrackio-cpp` package

### Transform stacking simplified

THe components of a transform no longer explicitly reference their parents; instead, by limiting the nesting flexibility, the parent-child relationships can be deduced rather than carried as metadata.

### `StrictlyPositiveRational` range corrected

The numerator of `StrictlyPositiveRational` objects was changed to have a minimum value of one (from the prior minimum value of zero).

### Type of `lens_exposure_falloff` corrected

The type of the `lens_exposure_falloff` parameter was corrected to be `ExposureFalloff` rather than the prior `Orientations`.

### Type of `transforms` parameter` corrected

The type of the `transforms` parameter had been incorrectly specified as `Tuple[Transform]` and was corrected [sic] to be Tuple[Transforms]. (Really, it should have been Tuple[Transforms, ...] or tuple[Transforms, ...] as it later came to be reimplemented in Pydantic)

### `LensCustom` description improved

The grammar of the docstring was changed to be more clear.

### Rational range corrected

The upper limit for the numerator orf a rational is that of a signed 32-bit int and not an unsigned one.

### Regular expression simplified

The regular expression used to identify a PTP leader was simplified to not use backreferences, in anticipation of the more limited regex parser in Pydantic.

### Many docstrings made more consistent

Many docstrings were corrected to comply with PEP 257.

### `StrictlyPositiveRealParameter` defined and used

A new numeric type was defined that usefully represented focal length and focus distance.

### JSON schema improvements

The schema expression of array size bounds was corrected to use minItems instead of the previous minLength (which is only appropriate for strings)

### Avoid magic numbers

Some instances of long "magic numbers" were replaced with symbolic values such as `INT_MAX`.

### Protocol version semantics clarified

The definition of `ProtocolVersion` was changed to enforce that both name and semantic version number must be present.

### `README.md` updated and `MIGRATION.md` added

The `README.md` file was modernized and a new `MIGRATION.md` file was (prematurely) added describing what API clients needed to understand about the upcoming rebasing of `camdkit` on Pydantic.

### Example code refactored

The example code was refactored to make it more clear that a static clip was an augmentation of a dynamnic clip (i.e. one containing regular metadata).

### Docstring and other comment typos corrected

Several misspellings were remedied.

### Missing copyright supplied and existing copyright corrected

Copyright info was added to `opentrackIO_parser.cpp` and updated for `opentrackIOlib.{cpp, h}`

### PTP `master` changed to PTP `leader` 

This naming change brings `camdkit` in line with SMPTE, AMPAS, and ASWF practice.

### Completely rewritten C++ library and parser

The C++ library and parser implementation was completely rewritten. 

## Changes after 0.9.0 and before 0.9.1

### Distortion models are named

In addition to the prior arrays of floating-point coefficients for radial and (optionally) tangential distortion, distortion models have an optional name, represented as a string. 

### Timecode Format objects represent partial frames differently

`TimecodeFormat` objects gain `sub_frame`, and lose `drop_frame` and `odd_field`

### `timing_frame_rate` becomes `timing_sample_rate`

### The OpenTrackingIO protocol version changes type

The OpenTrackingIO protocol version is no longer a name string and a version string, but is now a name string and a 3-tuple of integers conforming to semantic versioning rules for major, minor and patch releases. 

### ID-related transform fields are simplified

A `Transform` now has `id` and `parentId` fields instead of `transformId` and `parentTransformId`.

### Centre shifts renamed

`LensDistortionShift` becomes `LensDistortionOffset` and `LensPerspectiveShift` becomes `LensProjectionOffset`.

### Unused PTP resolution is removed

The PTP timestamp `attoseconds` field has been removed.

### Timecode maximum resolution increased

Timecode can now be represented up to and including 120 frames per second.

### New parameter added to aid in interpreting overscan values

A new static parameter, `lens_distortion_is_projection`, indicates when the lens distortion model being used is the projection characterization and not the field-of-view characterization.

### Distortion overscan values limited to unity or more

Both dynamic overscan values and maximum overscan values are restricted to have values equal to or greater than one.

### Various type hint improvements made

### Distortion objects become lists of distortion objects

The dynamic distortion metadata is now a list of distortion objects, allowing a transmitter of distortion data to multicast that data to receivers expecting coefficients for a variety of distortion models.

### PTP domain value range established

The PTP domain field now must be between 0 and 127 inclusive.

### The SMPTE main page is now linked

A link was added to [SMPTE.org](https://www.smpte.org).


